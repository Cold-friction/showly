name: Master Flow

on:
  workflow_dispatch:
    inputs:
      override_version:
        description: 'Override auto version (e.g., 2.5.0-amoled). Leave empty for auto.'
        required: false
        default: ''
      notes:
        description: 'Release notes (supports Markdown)'
        required: false
        default: 'ðŸŒ‘ AMOLED Black Theme â€” pure #000000 backgrounds. Signed release build.'
      draft:
        description: 'Create as draft?'
        type: boolean
        default: true
      prerelease:
        description: 'Mark as pre-release?'
        type: boolean
        default: true

jobs:

  verify-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      # 1ï¸âƒ£ Setup Android SDK + cache it
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ~/.android
          key: ${{ runner.os }}-android-sdk-v1
          restore-keys: ${{ runner.os }}-android-sdk-

      # 2ï¸âƒ£ Cache Gradle (static key)
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-v1
          restore-keys: ${{ runner.os }}-gradle-

      # 5ï¸âƒ£ Setup JDK (with Gradle cache)
      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # 4ï¸âƒ£ Cache Build Cache (KSP + Hilt generated classes)
      - name: Cache Build Cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches/build-cache-1
          key: ${{ runner.os }}-gradle-buildcache-v1
          restore-keys: ${{ runner.os }}-gradle-buildcache-

      # Lint
      - name: Auto-fix lint errors
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/download/1.5.0/ktlint
          chmod a+x ktlint
          ./ktlint --format --relative .

      - name: Run ktlint
        run: ./ktlint --relative .

  verify-tests:
    runs-on: ubuntu-latest
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
      TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      KEYSTORE_FILE: app/keystore.jks
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ~/.android
          key: ${{ runner.os }}-android-sdk-v1
          restore-keys: ${{ runner.os }}-android-sdk-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-v1
          restore-keys: ${{ runner.os }}-gradle-

      - name: Cache Build Cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches/build-cache-1
          key: ${{ runner.os }}-gradle-buildcache-v1
          restore-keys: ${{ runner.os }}-gradle-buildcache-

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Keystore
      - name: Restore Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks

      - name: Run Unit Tests
        run: ./gradlew test

      - name: Cleanup Keystore
        if: always()
        run: rm -f app/keystore.jks

  build-and-release:
    needs: [ verify-lint, verify-tests ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
      TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      KEYSTORE_FILE: app/keystore.jks
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: ~/.android
          key: ${{ runner.os }}-android-sdk-v1
          restore-keys: ${{ runner.os }}-android-sdk-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-v1
          restore-keys: ${{ runner.os }}-gradle-

      - name: Cache Build Cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches/build-cache-1
          key: ${{ runner.os }}-gradle-buildcache-v1
          restore-keys: ${{ runner.os }}-gradle-buildcache-

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Generate version
      - name: Generate Version
        id: version
        run: |
          COMMIT_SHORT=${GITHUB_SHA::7}
          AUTO_VERSION="amoled-$(date +'%y.%m.%d')-${COMMIT_SHORT}"
          OVERRIDE="${{ github.event.inputs.override_version }}"
          FINAL_VERSION="${OVERRIDE:-$AUTO_VERSION}"
          echo "value=$FINAL_VERSION" >> $GITHUB_OUTPUT

      # Keystore
      - name: Restore Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks

      - name: Verify Keystore Exists
        run: |
          if [ ! -f "app/keystore.jks" ]; then
            echo "ERROR: Keystore file not found"
            exit 1
          fi

      # Build
      - name: Build Signed Release APK
        run: ./gradlew app:assembleRelease -x test -x lint

      # Upload
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: showly-${{ steps.version.outputs.value }}-release
          path: app/build/outputs/apk/release/app-release.apk

      # Git tag
      - name: Create Git Tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          TAG="v${{ steps.version.outputs.value }}"
          git tag -a "$TAG" -m "Release ${{ steps.version.outputs.value }}"
          git push origin "$TAG"

      # Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.value }}"
          name: "Showly ${{ steps.version.outputs.value }}"
          body: ${{ github.event.inputs.notes }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: app/build/outputs/apk/release/app-release.apk

      # Cleanup
      - name: Cleanup Keystore
        if: always()
        run: rm -f app/keystore.jks
