name: Master Flow

on:
  workflow_dispatch:
    inputs:
      override_version:
        description: 'Override auto version (e.g., 2.5.0-amoled). Leave empty for auto.'
        required: false
        default: ''
      notes:
        description: 'Release notes (supports Markdown)'
        required: false
        default: 'ðŸŒ‘ AMOLED Black Theme â€” pure #000000 backgrounds. Signed release build.'
      draft:
        type: boolean
        default: true
      prerelease:
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
      TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Restore Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "${{ runner.temp }}/keystore.jks"
          chmod 600 "${{ runner.temp }}/keystore.jks"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          cache-cleanup: true

      - name: Download ktlint
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/download/1.5.0/ktlint
          chmod a+x ktlint

      - name: Run ktlint
        run: ./ktlint --relative --format .

      - name: Run Tests
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/keystore.jks
        run: ./gradlew testRelease --parallel --no-daemon --stacktrace

      - name: Cleanup Keystore
        if: always()
        run: shred -vfz -n 3 "${{ runner.temp }}/keystore.jks" 2>/dev/null || rm -f "${{ runner.temp }}/keystore.jks"

  build-and-release:
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
      TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: gradle

      - name: Restore Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "${{ runner.temp }}/keystore.jks"
          chmod 600 "${{ runner.temp }}/keystore.jks"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true
          cache-cleanup: true

      - name: Generate Version
        id: version
        run: |
          COMMIT_SHORT=${GITHUB_SHA::7}
          AUTO_VERSION="amoled-$(date +'%y.%m.%d')-${COMMIT_SHORT}"
          FINAL_VERSION="${{ github.event.inputs.override_version || '' }}"
          echo "value=${FINAL_VERSION:-$AUTO_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build Signed Release APK
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/keystore.jks
        run: |
          ./gradlew app:assembleRelease \
            -x test -x lint \
            --parallel \
            --no-daemon \
            --stacktrace

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest-apk
          retention-days: 1
          path: app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error

      - name: Create Git Tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          TAG="v${{ steps.version.outputs.value }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.value }}"
          name: "Showly ${{ steps.version.outputs.value }}"
          body: ${{ github.event.inputs.notes }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: app/build/outputs/apk/release/app-release.apk

      - name: Cleanup Old Releases & Tags
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const rel of releases.data.slice(1)) {
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: rel.id
              });
            }
            
            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            for (const tag of tags.slice(1)) {
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${tag.name}`
                });
              } catch (e) {
                console.log(`Failed to delete tag ${tag.name}: ${e.message}`);
              }
            }

      - name: Cleanup Keystore
        if: always()
        run: shred -vfz -n 3 "${{ runner.temp }}/keystore.jks" 2>/dev/null || rm -f "${{ runner.temp }}/keystore.jks"
